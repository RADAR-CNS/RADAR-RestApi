plugins {
  // Apply the java plugin to add support for Java
  id 'java'
  id 'idea'
  id 'com.commercehub.gradle.plugin.avro-base' version '0.8.0'
  id 'pmd'
  id 'checkstyle'
  id 'jacoco'
  id 'war'
}

war {
  archiveName = 'radar.war'
}

targetCompatibility = '1.7'
sourceCompatibility = '1.7'

ext.avro='1.7.7'
ext.codacyVersion = '1.0.10'
ext.dataformat = '2.8.5'
ext.jackson='2.8.4'
ext.jersey = '2.22.1'
ext.jerseymedia = '2.24'
ext.json='20160810'
ext.junitVersion = '4.12'
ext.logback = '1.1.7'
ext.mathVersion = '3.0'
ext.mokitoVersion ='1.10.19'
ext.mongodb='3.3.0'
ext.okhttpVersion = '3.5.0'
ext.okioVersion = '1.11.0'
ext.openCsvVersion = '3.9'
ext.radarCommon = '0.1'
ext.snakeyaml='1.17'
ext.swagger='1.5.0'
ext.tomcat = '8.0.37'

configurations {
  codacy
  integrationTestCompile.extendsFrom testCompile
  integrationTestRuntime.extendsFrom testRuntime
  provided
  compile.extendsFrom provided
}

// In this section you declare where to find the dependencies of your project
repositories {
  // Use 'jcenter' for resolving your dependencies.
  // You can declare any Maven/Ivy/file repository here.
  jcenter()
  maven { url 'http://packages.confluent.io/maven/' }
  maven { url 'https://jitpack.io' }
  maven { url 'http://dl.bintray.com/typesafe/maven-releases' }
  maven { url 'https://dl.bintray.com/radar-cns/org.radarcns' }
}

// In this section you declare the dependencies for your production and test code
dependencies {
  // The production code runs on tomcat 8.0.37
  providedCompile group: 'org.apache.tomcat', name: 'tomcat-catalina', version: tomcat

  // The production code uses the SLF4J logging API at compile time
  compile group: 'ch.qos.logback', name:'logback-classic', version: logback

  compile group: 'org.glassfish.jersey.containers', name: 'jersey-container-servlet', version: jersey
  compile group: 'org.json', name: 'json', version: json
  compile group: 'io.swagger', name: 'swagger-jersey2-jaxrs', version: swagger
  compile group: 'org.mongodb', name: 'mongo-java-driver', version: mongodb
  compile group: 'ch.qos.logback', name: 'logback-classic', version: logback
  compile group: 'org.apache.avro', name: 'avro', version: avro
  compile group: 'com.fasterxml.jackson.datatype', name: 'jackson-datatype-joda', version: jackson
  compile group: 'org.yaml', name: 'snakeyaml', version: snakeyaml
  compile group: 'org.glassfish.jersey.media', name: 'jersey-media-json-jackson', version: jerseymedia
  compile group: 'com.fasterxml.jackson.dataformat', name: 'jackson-dataformat-avro', version: dataformat
  compile group: 'org.radarcns', name: 'radar-commons', version: radarCommon

  testCompile group: 'junit', name: 'junit', version: junitVersion
  testCompile group: 'com.opencsv', name: 'opencsv', version: openCsvVersion
  testCompile group: 'org.apache.commons', name: 'commons-math3', version: mathVersion
  testCompile group: 'com.squareup.okhttp3', name: 'okhttp', version: okhttpVersion
  testCompile group: 'com.squareup.okio', name: 'okio', version: okioVersion
  testCompile group: 'org.mockito', name: 'mockito-all', version: mokitoVersion

  codacy group: 'com.github.codacy', name: 'codacy-coverage-reporter', version: codacyVersion
}

//---------------------------------------------------------------------------//
// AVRO file manipulation                                                    //
//---------------------------------------------------------------------------//

task generateAvro(type: com.commercehub.gradle.plugin.avro.GenerateAvroJavaTask) {
  source("schemas/restapi")
  outputDir = file("build/avro")
}

compileJava.source(generateAvro.outputs)

//---------------------------------------------------------------------------//
// Style checking                                                            //
//---------------------------------------------------------------------------//

checkstyle {
  // codacy version
  toolVersion '6.16'
  ignoreFailures true

  // ignore tests
  sourceSets = [sourceSets.main]
}

pmd {
  // pmd version
  toolVersion = '5.5.2'
  ignoreFailures = true

  // ignore tests
  sourceSets = [sourceSets.main]

  consoleOutput = true

  ruleSets = []
  ruleSetFiles = files("config/pmd/ruleset.xml")
}


pmdTest {
  ruleSetFiles = files("config/pmd/test_ruleset.xml")
}

//---------------------------------------------------------------------------//
// Testing                                                                   //
//---------------------------------------------------------------------------//

sourceSets {
  integrationTest {
    java {
      compileClasspath += main.output
      runtimeClasspath += main.output
    }
    resources {
      srcDir 'src/integrationTest/resources'
    }
  }
}

test {
  testLogging {
    // Show that tests are run in the command-line output
    events "skipped", "failed"
  }
}

task integrationTest(type: Test) {
  description = "Run integration tests (located in src/integrationTest/...)."

  testClassesDir = sourceSets.integrationTest.output.classesDir
  classpath = sourceSets.integrationTest.runtimeClasspath

  // This is not needed, but I like to see which tests have run
  testLogging {
    events "skipped", "failed"
  }
}

check.dependsOn integrationTestClasses

//---------------------------------------------------------------------------//
// Code coverage and codacy                                                  //
//---------------------------------------------------------------------------//

jacocoTestReport {
  executionData test, integrationTest
  reports {
    xml.enabled true
    csv.enabled false
    html.enabled true
  }
}

task downloadDependencies(type: Exec) {
  configurations.testRuntime.files
  configurations.codacy.files
  configurations.jacocoAnt.files
  commandLine 'echo', 'Downloaded all dependencies'
}

task sendCoverageToCodacy(type: JavaExec, dependsOn: jacocoTestReport) {
  main = 'com.codacy.CodacyCoverageReporter'
  classpath = configurations.codacy
  args = ['-l', 'Java', '-r', "${buildDir}/reports/jacoco/test/jacocoTestReport.xml"]
}

//---------------------------------------------------------------------------//
// Build system metadata                                                     //
//---------------------------------------------------------------------------//

idea {
  module {
    sourceDirs += file("build/avro")
  }
}

task wrapper(type: Wrapper) {
  gradleVersion = '3.0'
}