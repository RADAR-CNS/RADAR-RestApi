//---------------------------------------------------------------------------//
// Docker Utility                                                            //
//---------------------------------------------------------------------------//
ext.dockerCompose = hasProperty('dockerComposePath') ? property('dockerComposePath') : 'docker-compose'
ext.sudoLinux = System.properties['os.name'].toLowerCase().contains('linux') ? ['sudo'] : []

//---------------------------------------------------------------------------//
// Simple Stack [ for integration test ]                                     //
//---------------------------------------------------------------------------//
ext.simpleStackPath = 'src/integrationTest'
ext.simpleStackLock = "${simpleStackPath}/.RUNNING_INSTANCE_LOCK"

task buildDocker(type: Exec, dependsOn: 'copyWarForIntegration') {
  workingDir 'src/integrationTest/image'
  commandLine sudoLinux + ['docker', 'image', 'build', '-t', 'radarcns/radar-restapi:dev', '.']
}

task installSimpleStack(type: Exec, dependsOn: 'buildDocker') {
  doFirst{
    def lockFile = new File(simpleStackLock)
    if (lockFile.exists()) {
      throw new GradleException("A previous instance of the simple stack is still running. Please stop it first and then try again.")
    } else {
      lockFile.createNewFile()
    }

    def radarVolumePath = "${simpleStackPath}/volumes/radar"
    file(radarVolumePath).mkdirs()

    def configJson = file("${simpleStackPath}/resources/config.json")
    file("${radarVolumePath}/config.json") << configJson.text

    def catalogYml = file("${simpleStackPath}/resources/device-catalog.yml")
    file("${radarVolumePath}/device-catalog.yml") << catalogYml.text

    def radarYml = file("${simpleStackPath}/resources/radar.yml")
    file("${radarVolumePath}/radar.yml") << radarYml.text.replace("localhost: 27017", "hotstorage: 27017")
  }

  workingDir simpleStackPath
  standardInput = System.in
  commandLine sudoLinux + [dockerCompose, 'up', '-d', '--build']

  doLast {
    // wait until the hotstorage is ready
    sleep(10_000)
  }
}

task stopSimpleStack(type: Exec) {
  onlyIf{
    new File(simpleStackLock).exists()
  }
  standardInput = System.in
  workingDir simpleStackPath
  commandLine sudoLinux + [dockerCompose, 'down', '-v']
  doLast{
    new File(simpleStackLock).delete()
  }
}

task cleanSimpleStack(type: Delete, dependsOn: stopSimpleStack) {
  delete "${simpleStackPath}/volumes"
  delete simpleStackLock
}
stopSimpleStack.finalizedBy cleanSimpleStack

//---------------------------------------------------------------------------//
// End to End Test                                                           //
//---------------------------------------------------------------------------//
ext.radarStackPath = 'src/endToEndTest/dockerRadar/dcompose-stack/radar-cp-hadoop-stack'
ext.radarStackLock = "${radarStackPath}/.RUNNING_INSTANCE_LOCK"
ext.radarDockerCompose = 'docker-compose.yml'
ext.radarDockerComposeOriginal = ".${radarDockerCompose}.orig"

// Sets configuration files for running the entire platform
task setRadarEnvironmentForDocker {
  doLast {
    def envTemplatePath = "${radarStackPath}/etc/env.template"
    def smtpTemplatePath = "${radarStackPath}/etc/smtp.env.template"
    def streamTemplatePath = "${radarStackPath}/etc/radar.yml.template"

    def volumes = file("${radarStackPath}/volumes")
    volumes.mkdir()

    def fileEnv = file(envTemplatePath + 'tmp')
    fileEnv << file(envTemplatePath).text
    fileEnv.text = fileEnv.text.replace('/usr/local/var/lib/docker', volumes.getAbsolutePath())
    fileEnv.text = fileEnv.text.replace('HOTSTORAGE_USERNAME=<mongodb-user>', 'HOTSTORAGE_USERNAME=restapi')
    fileEnv.text = fileEnv.text.replace('HOTSTORAGE_PASSWORD=XXXXXXXX', 'HOTSTORAGE_PASSWORD=radarcns')
    fileEnv.text = fileEnv.text.replace('HOTSTORAGE_NAME=<mongodb-database>', 'HOTSTORAGE_NAME=hotstorage')
    fileEnv.renameTo("${radarStackPath}/.env")

    def fileSmtp = file(smtpTemplatePath + 'tmp')
    fileSmtp << file(smtpTemplatePath).text
    fileSmtp.renameTo("${radarStackPath}/etc/smtp.env")

    def fileStream = file(streamTemplatePath + 'tmp')
    fileStream << file(streamTemplatePath).text
    fileStream.renameTo("${radarStackPath}/etc/radar.yml")

    def installScript = file("${radarStackPath}/install-radar-stack.sh")
    installScript.text = installScript.text.replace(' docker-compose ', " ${dockerCompose} ")

    def dockerComposeYml = file("${radarStackPath}/${radarDockerCompose}")
    file("${radarStackPath}/${radarDockerComposeOriginal}") << dockerComposeYml.text
    def dockerComposeTmp = file("${radarStackPath}/.${radarDockerCompose}.tmp")
    dockerComposeTmp << dockerComposeYml.text.replaceAll('radarcns/radar-restapi:.*', 'radarcns/radar-restapi:dev')
    dockerComposeTmp.renameTo("${radarStackPath}/${radarDockerCompose}")
  }
}

task installRadarStack(type: Exec, dependsOn: ['setRadarEnvironmentForDocker', 'buildDocker']) {
  doFirst{
    def lockFile = new File(radarStackLock)
    if (lockFile.exists()) {
      throw new GradleException("A previous instance of RADAR Platform is still running. Please stop it first and then try again.")
    } else {
      lockFile.createNewFile()
    }
  }

  workingDir radarStackPath
  standardInput = System.in
  commandLine sudoLinux + ['./install-radar-stack.sh']
}

task listDockerProcesses(type: Exec) {
  workingDir radarStackPath
  standardInput = System.in
  commandLine sudoLinux + [dockerCompose, 'ps']
}
listDockerProcesses.mustRunAfter 'installRadarStack'

ext.stoppingStack = false
task stopRadarStack(type: Exec) {
  onlyIf{
    new File(radarStackLock).exists() && !stoppingStack
  }
  doFirst{
    stoppingStack = true
  }

  standardInput = System.in
  workingDir radarStackPath
  commandLine sudoLinux + [dockerCompose, 'down', '-v']

  doLast{
    stoppingStack = false
  }
}

task cleanRadarStack(type: Exec, dependsOn: 'stopRadarStack') {
  onlyIf{
    !stoppingStack
  }
  commandLine sudoLinux + ['rm', '-rf', "${radarStackPath}/volumes", radarStackLock]
  doLast{
    file("${radarStackPath}/${radarDockerComposeOriginal}").renameTo("${radarStackPath}/${radarDockerCompose}")
  }
}
stopRadarStack.finalizedBy cleanRadarStack

//---------------------------------------------------------------------------//
// Prepare FRONT-END config file                                             //
//---------------------------------------------------------------------------//
task copyFrontendConfig(type: Copy) {
  from "${projectDir}/schemas/restapi/config/config.json"
  into "${projectDir}/src/main/webapp/frontend/"
}

task copyFrontendConfigIntegrationTest(type: Copy) {
  from "${projectDir}/schemas/restapi/config/config.json"
  into "${projectDir}/src/integrationTest/resources"
}

task copyFrontendConfigEndToEndTest(type: Copy) {
  from "${projectDir}/schemas/restapi/config/config.json"
  into "${projectDir}/src/endToEndTest/resources"
}

task removeFrontendConfig(type: Delete) {
  delete "${projectDir}/src/main/webapp/frontend/"
  delete "${projectDir}/src/integrationTest/resources/config.json"
  delete "${projectDir}/src/endToEndTest/resources/config.json"
}

//---------------------------------------------------------------------------//
// Prepare WAR                                                               //
//---------------------------------------------------------------------------//
task copyWarForIntegration(type: Copy, dependsOn: 'war') {
  from war.archivePath
  into "${projectDir}/src/integrationTest/image"
  doLast{
    file("${projectDir}/src/integrationTest/image/${war.archiveName}").renameTo("${projectDir}/src/integrationTest/image/radar.war")
  }
}

task removeWar(type: Delete) {
  delete "${projectDir}/src/integrationTest/image/radar.war"
}